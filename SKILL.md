---
name: version-generate
description: 從最新的 git tag 到 HEAD 生成結構化變更日誌並推薦新版本。當使用者請求生成變更日誌、發行說明或版本升級文件時使用。
---

# 版本產生器

從最新的 git tag 到 HEAD 生成 `vA.B.C.md` 變更日誌,其中 `vA.B.C` 是**推薦的新版本**。

## 工作流程

1. 從 git 取得最新版本標籤 (`LATEST_TAG`)
2. 收集 `LATEST_TAG` 與 HEAD 之間的差異
3. 分類變更並計算**新版本** (`NEW_VERSION`)
4. 生成 `./NEW_VERSION.md`

## 步驟 1: 版本偵測

```bash
git fetch --tags --quiet 2>/dev/null

# 取得最新語義化版本標籤
LATEST_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -1)

if [ -z "$LATEST_TAG" ]; then
    LATEST_TAG="v0.0.0"
fi

echo "Current: $LATEST_TAG"
```

## 步驟 2: 收集變更

```bash
# 取得從最新標籤到 HEAD 的差異
git diff $LATEST_TAG..HEAD

# 取得自標籤以來的提交清單
git log $LATEST_TAG..HEAD --oneline

# 取得變更檔案摘要
git diff $LATEST_TAG..HEAD --stat
```

## 步驟 3: 分類標籤

| 標籤 | 範圍 | 範例 | 版本影響 |
|-----|-------|----------|----------------|
| `FEAT` | 新功能 | 新函式、端點、元件 | **MINOR** (+0.1.0) |
| `FIX` | 錯誤修正 | 錯誤處理、邏輯修正、nil 檢查 | PATCH (+0.0.1) |
| `UPDATE` | 修改現有行為 | 參數變更、演算法調整 | PATCH |
| `ADD` | 新增檔案/資源 (非功能) | 設定檔、資源、相依性 | PATCH |
| `REMOVE` | 刪除 | 棄用程式碼、未使用的檔案 | PATCH |
| `REFACTOR` | 程式碼重構 (無行為變更) | 提取函式、重新命名、重組 | PATCH |
| `PERF` | 效能改善 | 快取、演算法最佳化 | PATCH |
| `STYLE` | 僅格式化 | 空白、linting、import 順序 | — (不升版) |
| `DOC` | 文件 | 註解、README、docstrings | — (不升版) |
| `TEST` | 測試相關 | 新測試、測試修正、覆蓋率 | — (不升版) |
| `CHORE` | 維護 | CI/CD、工具、版本升級 | — (不升版) |
| `SECURITY` | 安全性修補 | 漏洞修正、驗證加固 | PATCH |
| `BREAKING` | 破壞性變更 | API 簽章變更、移除 | **MAJOR** (+1.0.0) |

## 步驟 4: 版本升級規則

```
LATEST_TAG = vX.Y.Z (預設: v0.0.0)

IF LATEST_TAG == v0.0.0 (不存在標籤):
    NEW_VERSION = v0.1.0

ELSE:
    MAJOR_TAGS = [BREAKING]
    MINOR_TAGS = [FEAT]
    PATCH_TAGS = [SECURITY, FIX, UPDATE, ADD, REMOVE, REFACTOR, PERF]
    NO_BUMP    = [STYLE, DOC, TEST, CHORE]

    IF any MAJOR_TAGS present:
        NEW_VERSION = v(X+1).0.0
    ELSE IF any MINOR_TAGS present:
        NEW_VERSION = vX.(Y+1).0
    ELSE IF any PATCH_TAGS present:
        NEW_VERSION = vX.Y.(Z+1)
    ELSE:
        NEW_VERSION = LATEST_TAG (無變更)
```

**範例:**
- `LATEST_TAG = v1.2.3` + 偵測到 `FEAT` → `NEW_VERSION = v1.3.0`
- `LATEST_TAG = v1.2.3` + 偵測到 `FIX` → `NEW_VERSION = v1.2.4`
- `LATEST_TAG = v1.2.3` + 偵測到 `BREAKING` → `NEW_VERSION = v2.0.0` 

## 步驟 5: 輸出格式

生成 `./NEW_VERSION.md` (例如, `v1.3.0.md`):

```markdown
> vX.Y.Z -> vA.B.C

## Summary

Brief 1-2 sentence overview of changes.
<details>
<summary>翻譯</summary>
變更的簡要說明(1-2句話)
</details>

## Changes

### FEAT
- Description of new feature

<details>
<summary>翻譯</summary>

- 新功能描述

</details>

### FIX
- Description of bug fix

<details>
<summary>翻譯</summary>

- 錯誤修正描述

</details>

### UPDATE
- Description of modification

<details>
<summary>翻譯</summary>

- 修改描述

</details>

### REFACTOR
- Description of restructure

<details>
<summary>翻譯</summary>

- 重構描述

</details>

### PERF
- Description of performance improvement

<details>
<summary>翻譯</summary>

- 效能優化描述

</details>

### SECURITY
- Description of security patch

<details>
<summary>翻譯</summary>

- 安全性修補描述

</details>

### DOC
- Description of documentation change

<details>
<summary>翻譯</summary>

- 文件變更描述

</details>

### CHORE
- Description of maintenance task

<details>
<summary>翻譯</summary>

- 維護任務描述

</details>

***

## Files Changed

| File | Status | Tag |
|------|--------|-----|
| `path/to/file.go` | Modified | FEAT |
| `path/to/other.go` | Added | ADD |
| `path/to/removed.go` | Deleted | REMOVE |

***

Generated by [SKILL](https://github.com/pardnchiu/skill-version-generate)
```

## 分類規則

1. **版本優先順序**: `BREAKING` > `FEAT` > `PATCH_TAGS` > `NO_BUMP`
2. **最高優先**: 單一 `BREAKING` 變更 → MAJOR 升級,無論其他標籤
3. **空白區段**: 省略沒有變更的標籤
4. **首次發行**: 無現有標籤 → `v0.1.0`
5. **無功能變更**: 僅 `STYLE`/`DOC`/`TEST`/`CHORE` → 保持目前版本
6. **群組相關變更**: 將相似變更合併到同一標籤下
7. **範圍階層**: `BREAKING` > `SECURITY` > `FEAT` > `FIX` > 其他 > `DOC`
8. **描述格式**: 以動詞開頭 — Add、Fix、Update、Remove、Refactor
9. **聚焦於意圖**: 描述變更內容及原因,而非個別檔案

## 邊界案例

- **帶有功能的新檔案** → `FEAT` (非 `ADD`)
- **新功能的測試** → `TEST` (與 `FEAT` 分開)
- **重新命名 + 修改** → `REFACTOR` + `UPDATE` (兩個條目)
- **刪除棄用 + 新增替代** → `REMOVE` + `FEAT`
- **.gitignore 變更** → `CHORE`
- **go.mod/go.sum** → `CHORE` (相依性管理)
- **自標籤後無提交** → 跳過生成或註記「無變更」
